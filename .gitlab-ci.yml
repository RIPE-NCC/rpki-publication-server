stages:
  - build
  - deploy

rpki-publication-server:
  stage: build
  image: $CI_REGISTRY/swe/gitlab-ci/sbt:1.3-2.12-jdk-8


  script:
    - sbt clean test universal:packageZipTarball 
  artifacts:
    paths:
      - target/universal/rpki-publication-server-1.1-SNAPSHOT.tgz

docker-latest:
  stage: release
  image: docker:latest
  needs:
    - rpki-publication-server 
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --tag $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:latest
  when:
    manual

# will eventually enable this
#  only:
#    refs:
#      - master@rpki/rpki-publication-server

